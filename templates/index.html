<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalorické Tabulky - Studijní Vyhledávač</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Styly pro skenování čárových kódů */
        .barcode-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .barcode-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .barcode-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .barcode-video-container {
            position: relative;
            width: 100%;
            margin: 20px 0;
        }
        
        #barcodeVideo {
            width: 100%;
            border-radius: 8px;
            background: #000;
        }
        
        .barcode-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 30%;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            pointer-events: none;
        }
        
        .barcode-scanner-line {
            position: absolute;
            height: 2px;
            width: 100%;
            background: #4CAF50;
            animation: scan 2s infinite ease-in-out;
        }
        
        @keyframes scan {
            0% { top: 0; }
            50% { top: calc(100% - 2px); }
            100% { top: 0; }
        }
        
        .barcode-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .barcode-btn {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .barcode-btn:hover {
            background-color: #45a049;
        }
        
        .barcode-btn.secondary {
            background-color: #f44336;
        }
        
        .barcode-btn.secondary:hover {
            background-color: #d32f2f;
        }
        
        .barcode-manual-input {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .barcode-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .barcode-status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .barcode-status.error {
            background-color: #ffebee;
            color: #d32f2f;
            border: 1px solid #f44336;
        }
        
        .barcode-status.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #4CAF50;
        }
        
        .barcode-status.info {
            background-color: #e3f2fd;
            color: #1565c0;
            border: 1px solid #2196f3;
        }
    </style>
</head>
<body data-app-id="{{ app_id }}" data-firebase-config="{{ firebase_config_json }}">
    <div class="container">
        <!-- Zbytek vašeho kódu zůstává stejný -->
        <div class="sticky-header-wrapper">
            <div id="userIdDisplay"></div>
            <h1>Kalorická kalkulačka</h1>
            <img id="settingsIcon" src="{{ url_for('static', filename='icon/nastaveni.png') }}" alt="Nastavení" class="settings-icon">
            
            <div class="search-and-recipes-container">
                <div class="main-controls">
                    <button id="recipesButton" disabled>Recepty</button>
                    <button id="barcodeButton" style="margin-left: 10px;">
                        📷 Skenovat kód
                    </button>
                </div>
                
                <form id="searchForm">
                    <input type="text" id="query" name="query" placeholder="Zadejte název potraviny (např. jablko, kuře)">
                    <button type="submit">Vyhledat</button>
                </form>
            </div>
            
            <div id="loading">Vyhledávám...</div>
            <div id="error-message" class="error"></div>
        </div>
        
        <div id="results">
            <!-- Zde se budou zobrazovat výsledky -->
        </div>
    </div>
    
    <!-- Modální okno pro skenování čárových kódů -->
    <div id="barcodeModal" class="barcode-modal">
        <div class="barcode-modal-content">
            <span class="barcode-close" id="closeBarcodeModal">&times;</span>
            <h3>Skenovat čárový kód</h3>
            
            <div id="barcodeUnsupportedMessage" class="barcode-status info">
                <p>🔒 Skenování čárových kódů není v tomto prohlížeči dostupné</p>
                <p>Pro skenování kódů fotoaparátem:</p>
                <ul>
                    <li>Použijte HTTPS připojení (zabezpečené)</li>
                    <li>Povolte přístup ke kameře v prohlížeči</li>
                    <li>Zkuste moderní prohlížeč (Chrome, Firefox, Edge)</li>
                </ul>
            </div>
            
            <div id="barcodeScannerContainer">
                <div class="barcode-video-container">
                    <video id="barcodeVideo" autoplay playsinline></video>
                    <div class="barcode-overlay">
                        <div class="barcode-scanner-line"></div>
                    </div>
                </div>
                
                <div id="barcodeStatus" class="barcode-status"></div>
                
                <div class="barcode-controls">
                    <button id="toggleCameraButton" class="barcode-btn">Přepnout kameru</button>
                    <button id="toggleFlashButton" class="barcode-btn">Blesk</button>
                </div>
                
                <div class="barcode-manual-input">
                    <p>Můžete také zadat kód ručně:</p>
                    <input type="text" id="manualBarcodeInput" class="barcode-input" placeholder="Zadejte čárový kód">
                    <button id="submitManualBarcode" class="barcode-btn">Vyhledat</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Zbytek vašich modálních oken -->
    <div id="detailsModal" class="modal-overlay">
        <!-- ... -->
    </div>
    
    <script type="module">
        // Firebase imports a inicializace
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, where, getDocs, deleteDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Váš existující kód pro Firebase inicializaci
        const bodyElement = document.body;
        const appId = bodyElement.dataset.appId;
        const firebaseConfigString = bodyElement.dataset.firebaseConfig;
        
        let firebaseConfig = {};
        try {
            firebaseConfig = JSON.parse(firebaseConfigString);
        } catch (e) {
            console.error("Error parsing firebaseConfigString:", e);
        }
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let app, db, auth, userId;
        let isAuthReady = false;
        
        // Proměnné pro skenování čárových kódů
        let barcodeScannerActive = false;
        let stream = null;
        let currentDeviceId = null;
        let facingMode = 'environment';
        let flashEnabled = false;
        let barcodeDetector = null;
        let scanInterval = null;
        
        // Inicializace aplikace
        const initializeFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId || !firebaseConfig.apiKey) {
                    throw new Error("Firebase konfigurace je prázdná nebo neplatná.");
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth Ready. User ID:", userId);
                    } else {
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                            } catch (error) {
                                console.error("Error signing in with custom token:", error);
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                            }
                        } else {
                            await signInAnonymously(auth);
                            userId = auth.currentUser.uid;
                        }
                    }
                    isAuthReady = true;
                    document.getElementById('userIdDisplay').textContent = `Uživatel ID: ${userId}`;
                    document.getElementById('recipesButton').disabled = false;
                    
                    // Inicializace skeneru čárových kódů
                    initBarcodeScanner();
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        };
        
        // Funkce pro skenování čárových kódů
        function initBarcodeScanner() {
            const barcodeModal = document.getElementById('barcodeModal');
            const barcodeVideo = document.getElementById('barcodeVideo');
            const closeBarcodeModal = document.getElementById('closeBarcodeModal');
            const toggleCameraButton = document.getElementById('toggleCameraButton');
            const toggleFlashButton = document.getElementById('toggleFlashButton');
            const submitManualBarcode = document.getElementById('submitManualBarcode');
            const manualBarcodeInput = document.getElementById('manualBarcodeInput');
            const barcodeUnsupportedMessage = document.getElementById('barcodeUnsupportedMessage');
            const barcodeScannerContainer = document.getElementById('barcodeScannerContainer');
            const barcodeStatus = document.getElementById('barcodeStatus');
            const barcodeButton = document.getElementById('barcodeButton');
            
            // Ověření dostupnosti API pro skenování
            const isBarcodeDetectorAvailable = () => {
                return 'BarcodeDetector' in window;
            };
            
            const isCameraAvailable = () => {
                return navigator.mediaDevices && navigator.mediaDevices.getUserMedia;
            };
            
            // Nastavení zprávy o podpoře
            if (!isBarcodeDetectorAvailable() || !isCameraAvailable()) {
                barcodeUnsupportedMessage.style.display = 'block';
                barcodeScannerContainer.style.display = 'none';
                toggleCameraButton.style.display = 'none';
                toggleFlashButton.style.display = 'none';
            } else {
                barcodeUnsupportedMessage.style.display = 'none';
                barcodeScannerContainer.style.display = 'block';
                toggleCameraButton.style.display = 'inline-block';
                toggleFlashButton.style.display = 'inline-block';
                
                // Inicializace BarcodeDetector API
                try {
                    barcodeDetector = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'code_128', 'code_39'] });
                } catch (e) {
                    console.error('BarcodeDetector initialization failed:', e);
                    barcodeStatus.textContent = 'Skenování není podporováno v tomto prohlížeči';
                    barcodeStatus.className = 'barcode-status error';
                }
            }
            
            // Otevření modálního okna
            barcodeButton.addEventListener('click', () => {
                barcodeModal.style.display = 'flex';
                barcodeStatus.textContent = 'Připravuji skener...';
                barcodeStatus.className = 'barcode-status info';
                
                if (isBarcodeDetectorAvailable() && isCameraAvailable()) {
                    startCamera();
                }
            });
            
            // Zavření modálního okna
            closeBarcodeModal.addEventListener('click', closeBarcodeScanner);
            
            // Přepnutí kamery
            toggleCameraButton.addEventListener('click', toggleCamera);
            
            // Odeslání ručně zadaného kódu
            submitManualBarcode.addEventListener('click', () => {
                const barcode = manualBarcodeInput.value.trim();
                if (barcode) {
                    handleBarcodeDetected(barcode);
                } else {
                    barcodeStatus.textContent = 'Prosím, zadejte čárový kód';
                    barcodeStatus.className = 'barcode-status error';
                }
            });
            
            // Odeslání při stisku Enter
            manualBarcodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitManualBarcode.click();
                }
            });
        }
        
        // Spuštění kamery
        async function startCamera() {
            const barcodeVideo = document.getElementById('barcodeVideo');
            const barcodeStatus = document.getElementById('barcodeStatus');
            
            // Zastavíme existující stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            const constraints = {
                video: {
                    facingMode: facingMode,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            // Pokud máme uložené deviceId, použijeme ho
            if (currentDeviceId) {
                constraints.video.deviceId = { exact: currentDeviceId };
            }
            
            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                barcodeVideo.srcObject = stream;
                
                // Uložíme deviceId pro příště
                const videoTrack = stream.getVideoTracks()[0];
                if (videoTrack) {
                    currentDeviceId = videoTrack.getSettings().deviceId;
                }
                
                // Čekáme na načtení videa
                barcodeVideo.onloadedmetadata = () => {
                    barcodeVideo.play();
                    barcodeStatus.textContent = 'Namiřte na čárový kód';
                    barcodeStatus.className = 'barcode-status info';
                    startBarcodeScanning();
                };
            } catch (error) {
                console.error('Chyba při přístupu ke kameře:', error);
                barcodeStatus.textContent = 'Chyba: ' + error.message;
                barcodeStatus.className = 'barcode-status error';
            }
        }
        
        // Spuštění skenování čárových kódů
        function startBarcodeScanning() {
            const barcodeVideo = document.getElementById('barcodeVideo');
            const barcodeStatus = document.getElementById('barcodeStatus');
            
            // Zastavíme existující interval
            if (scanInterval) {
                clearInterval(scanInterval);
            }
            
            barcodeScannerActive = true;
            
            // Nastavíme interval pro kontrolu čárových kódů
            scanInterval = setInterval(async () => {
                if (barcodeVideo.readyState === barcodeVideo.HAVE_ENOUGH_DATA && barcodeScannerActive) {
                    try {
                        const barcodes = await barcodeDetector.detect(barcodeVideo);
                        
                        if (barcodes.length > 0) {
                            const barcode = barcodes[0].rawValue;
                            handleBarcodeDetected(barcode);
                        }
                    } catch (error) {
                        console.error('Chyba při detekci čárového kódu:', error);
                    }
                }
            }, 500); // Kontrolujeme každých 500ms
        }
        
        // Zpracování nalezeného čárového kódu
        function handleBarcodeDetected(barcode) {
            const barcodeStatus = document.getElementById('barcodeStatus');
            
            console.log('Nalezen čárový kód:', barcode);
            
            // Vizuální feedback
            barcodeStatus.textContent = `Nalezen kód: ${barcode}`;
            barcodeStatus.className = 'barcode-status success';
            
            // Zastavíme skenování
            barcodeScannerActive = false;
            clearInterval(scanInterval);
            
            // Po krátké prodlevě zavřeme skener a vyhledáme
            setTimeout(() => {
                closeBarcodeScanner();
                searchByBarcode(barcode);
            }, 1000);
        }
        
        // Přepnutí kamery (přední/zadní)
        async function toggleCamera() {
            const barcodeStatus = document.getElementById('barcodeStatus');
            
            facingMode = facingMode === 'environment' ? 'user' : 'environment';
            barcodeStatus.textContent = 'Přepínám kameru...';
            barcodeStatus.className = 'barcode-status info';
            
            try {
                await startCamera();
            } catch (error) {
                console.error('Chyba při přepínání kamery:', error);
                barcodeStatus.textContent = 'Chyba: ' + error.message;
                barcodeStatus.className = 'barcode-status error';
            }
        }
        
        // Vyhledání podle čárového kódu
        function searchByBarcode(barcode) {
            // Nastavíme hodnotu do vyhledávacího pole
            document.getElementById('query').value = barcode;
            
            // Spustíme vyhledávání
            const searchForm = document.getElementById('searchForm');
            if (searchForm) {
                const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                searchForm.dispatchEvent(submitEvent);
            }
        }
        
        // Zavření skeneru čárových kódů
        function closeBarcodeScanner() {
            // Zastavíme skenování
            barcodeScannerActive = false;
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            
            // Zastavíme stream videa
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // Zastavíme video
            const barcodeVideo = document.getElementById('barcodeVideo');
            if (barcodeVideo) {
                barcodeVideo.srcObject = null;
            }
            
            // Skryjeme modální okno
            const barcodeModal = document.getElementById('barcodeModal');
            if (barcodeModal) {
                barcodeModal.style.display = 'none';
            }
            
            // Vyčistíme status
            const barcodeStatus = document.getElementById('barcodeStatus');
            if (barcodeStatus) {
                barcodeStatus.textContent = '';
                barcodeStatus.className = 'barcode-status';
            }
            
            // Vyčistíme ruční vstup
            const manualBarcodeInput = document.getElementById('manualBarcodeInput');
            if (manualBarcodeInput) {
                manualBarcodeInput.value = '';
            }
        }
        
        // Inicializace aplikace
        initializeFirebase();
        
        // Zbytek vašeho kódu...
    </script>
</body>
</html>
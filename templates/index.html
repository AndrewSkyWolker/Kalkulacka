<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalorické Tabulky - Studijní Vyhledávač</title>
    <style>
        body {
            font-family: 'Dutch801 Rm BT', serif; /* Změna písma na Dutch801 Rm BT */
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container { max-width: 800px; margin: auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 20px; } /* Centered heading */
        form { display: flex; justify-content: center; margin-bottom: 20px; }
        input[type="text"] { padding: 10px; width: 60%; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-left: 10px; }
        button:hover { background-color: #0056b3; }
        #results { margin-top: 20px; }
        .food-item {
            background-color: #e9e9e9;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            cursor: pointer;
            position: relative; /* Pro umístění food-type-label */
        }
        .food-item:hover {
            background-color: #e0e0e0;
        }
        .food-item h3 { margin: 0 0 5px 0; color: #007bff; }
        .food-item p { margin: 0; font-size: 0.9em; color: #555; }
        .food-item img {
            width: 60px;
            height: 60px;
            margin-right: 15px;
            object-fit: contain;
            border-radius: 4px;
        }
        .food-details {
            flex-grow: 1;
        }
        #loading { display: none; text-align: center; color: #888; }
        .error { color: red; text-align: center; margin-top: 10px; }
        .warning { color: orange; text-align: center; margin-top: 10px; font-size: 0.9em; }

        /* Styly pro modální okno */
        .modal-overlay {
            display: none; /* Skryté ve výchozím stavu */
            position: fixed;
            z-index: 1000; /* Higher z-index for modals */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px; /* Ponecháno 20px pro vnitřní odsazení obsahu */
            border: 1px solid #888;
            width: 80%; /* Původní šířka */
            max-width: 350px; /* Zúžení o cca 1/3 z 500px */
            border-radius: 8px;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .close-button {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 3px; /* Posunuto nahoru o 7px (z 10px na 3px) */
            right: 13px; /* Posunuto doprava o 7px (z 20px na 13px) */
            cursor: pointer;
            padding: 0; /* Zajištění, že aktivní oblast odpovídá vizuálnímu křížku */
            line-height: 1; /* Zajištění, že aktivní oblast odpovídá vizuálnímu křížku */
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-details {
            font-size: 0.95em;
        }
        .modal-details h3 {
            margin-top: 15px;
            margin-bottom: 5px;
            color: #333;
            font-size: 1.1em;
        }
        .modal-details p {
            margin-bottom: 3px;
        }
        .modal-details strong {
            color: #333;
        }
        .modal-details .loading-details, .modal-details .error-details {
            text-align: center;
            color: #888;
            margin-top: 10px;
        }
        .modal-details .error-details {
            color: red;
        }

        /* Styly pro zobrazení jako na obrázku */
        .nutrient-section {
            margin-bottom: 10px;
            padding-bottom: 5px;
        }
        .nutrient-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 2px;
        }
        .nutrient-label {
            display: flex;
            align-items: center;
            font-weight: bold;
        }
        .nutrient-label.main {
            font-size: 1.2em;
        }
        .nutrient-value {
            font-weight: bold;
        }
        .nutrient-value.main-value {
            font-size: 1.2em;
        }
        .nutrient-sub-label {
            margin-left: 20px; /* Odsazení pro podkategorie */
            font-size: 0.9em;
            color: #555;
        }
        .nutrient-sub-value {
             font-size: 0.9em;
             color: #555;
        }
        /* New class for specific font size and weight */
        .nutrient-normal-font {
            font-size: 1.05em; /* Adjusted font size */
            font-weight: normal; /* Normal font weight */
        }
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
        }
        .dot.red { background-color: #f44336; }
        .dot.blue { background-color: #2196f3; }
        .dot.orange { background-color: #ff9800; }
        .dot.green { background-color: #4caf50; } /* Pro Vlákninu */

        .energy-header {
            text-align: right; /* Zarovnání k pravému okraji */
            font-size: 2.1em; /* Zvětšená velikost písma o 3 body (z 1.8em na 2.1em) */
            font-weight: bold;
            margin-bottom: 5px;
        }
        .energy-sub-header {
            text-align: right; /* Zarovnání k pravému okraji */
            font-size: 0.9em;
            color: #777;
            margin-bottom: 0; /* Odstraněna spodní mezera pro přesnější zarovnání */
            white-space: nowrap; /* Zabrání rozdělení textu na více řádků */
        }

        /* Nové styly pro hlavičku detailu */
        .modal-header-content {
            display: flex; /* Použijeme flexbox */
            align-items: center; /* Vertikálně vycentrujeme položky */
            margin-bottom: 20px;
        }
        .modal-header-image {
            width: 120px; /* Zvětšená velikost obrázku a čtvercový tvar */
            height: 120px; /* Zvětšená velikost obrázku a čtvercový tvar */
            object-fit: cover; /* Oříznutí namísto deformace */
            margin-right: 15px;
            border-radius: 8px; /* Zaoblené rohy, odpovídající modálnímu oknu */
            flex-shrink: 0; /* Zabrání zmenšování obrázku */
        }
        .modal-header-name {
            flex-grow: 1; /* Povolí názvu zabrat dostupný prostor */
            flex-shrink: 1; /* Povolí názvu se zmenšit, pokud je potřeba */
            font-weight: bold;
            color: #333;
            text-align: center;
            line-height: 1.2;
            overflow: hidden; /* Skryje přetečení textu */
            display: flex; /* Použijeme flexbox pro vertikální centrování textu uvnitř divu */
            align-items: center; /* Vertikálně vycentruje text */
            justify-content: center; /* Horizontálně vycentruje text */
            height: 120px; /* Omezí výšku na výšku obrázku */
        }

        /* Nový kontejner pro interaktivní sekci (množství/jednotka a kalorie/kJ) */
        .interactive-section {
            display: flex;
            justify-content: space-between; /* Rozprostře položky na kraje */
            align-items: flex-end; /* Zarovná položky dole */
            margin-bottom: 15px;
            padding-left: 10px; /* Odsazení 10px od levého okraje */
            padding-right: 0; /* Změněno na 0 odsazení od pravého okraje */
        }

        /* Styly pro pole množství a jednotek */
        .amount-controls {
            display: flex; /* Použijeme flexbox */
            flex-direction: column; /* Položky pod sebou */
            align-items: flex-start; /* Zarovná položky doleva */
            gap: 10px; /* Mezera mezi inputem a selectem */
            flex-shrink: 0; /* Zabrání zmenšování */
        }

        .amount-input, .unit-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px; /* Zaoblení okrajů */
            font-family: 'Dutch801 Rm BT', serif; /* Změna písma */
            box-sizing: border-box; /* Zahrnuje padding a border do výpočtu šířky */
        }

        .amount-input {
            width: 100px; /* Šířka 100px */
            font-size: 1.3em; /* Zvětšené písmo */
            text-align: left; /* Zarovnání textu doleva */
        }

        .unit-select {
            width: 60px; /* Zmenšeno na polovinu */
            font-size: 0.8em; /* Zmenšené písmo */
            appearance: none; /* Odstranit výchozí šipku selectu */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="%23333" viewBox="0 0 10 10"><path d="M0 2.5 L5 7.5 L10 2.5 Z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 8px;
            margin: 0; /* Odstraněno automatické vycentrování */
        }

        /* Kontejner pro energetické hodnoty */
        .energy-display-group {
            flex-grow: 1; /* Povolí zabrat zbývající prostor */
            text-align: right; /* Zarovnání obsahu doprava */
            display: flex; /* Povolí flexbox pro zarovnání obsahu */
            flex-direction: column; /* Položky pod sebou */
            justify-content: flex-end; /* Zarovná obsah na konec (dole) */
        }

        /* Styly pro tlačítko Recepty a jeho možnosti */
        .main-controls {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Align to the left */
            margin-top: 0px; /* Adjusted margin */
            margin-bottom: 15px; /* Added margin to separate from search form */
            gap: 10px; /* Space between buttons */
        }
        .main-controls button {
            width: 150px; /* Smaller width for recipe button */
            padding: 12px 15px;
            background-color: #28a745; /* Green color for recipes */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 0; /* Reset margin */
        }
        .main-controls button:hover {
            background-color: #218838;
        }

        /* New modal for recipe options */
        #recipeOptionsModal .modal-content {
            max-width: 300px; /* Smaller width for recipe options modal */
            text-align: center;
            display: flex; /* Use flexbox for centering content */
            flex-direction: column; /* Arrange items in a column */
            align-items: center; /* Center items horizontally */
        }
        #recipeOptionsModal .modal-content h3 {
            margin-top: 0; /* Remove top margin for modal heading */
            margin-bottom: 20px; /* Add some space below heading */
            color: #333;
        }
        #recipeOptionsModal .modal-content button {
            width: 100%; /* Full width buttons inside modal */
            margin-bottom: 10px; /* Space between buttons */
            background-color: #28a745; /* Green color for recipe options */
        }
        #recipeOptionsModal .modal-content button:last-child {
            margin-bottom: 0;
        }
        #recipeOptionsModal .modal-content button:hover {
            background-color: #218838;
        }

        /* New style for nutrient line separator */
        .nutrient-line-separator {
            border-top: 1px solid #eee; /* Same style as existing separator */
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .food-type-label {
            position: absolute;
            top: 5px;
            right: 5px;
            /* Default background color - will be overridden by specific classes */
            background-color: #6366f1; /* Original purple */
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: capitalize;
            z-index: 10;
        }

        /* New styles for food item colors */
        .food-item.food-item-potravina {
            background-color: #e0f2f7; /* Light blue */
            border-color: #a7d9ed;
        }
        .food-item.food-item-recept {
            background-color: #e6ffe6; /* Light green */
            border-color: #b3e6b3;
        }

        /* Specific colors for food type labels */
        .food-type-label.potravina-label {
            background-color: #1a75ff; /* Vibrant blue, similar saturation to original purple */
        }

        .food-type-label.recept-label {
            background-color: #0baf0b; /* Vibrant green, similar saturation to original purple */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Kalorická kalkulačka</h1>

        <div class="main-controls">
            <button id="recipesButton">Recepty</button>
        </div>

        <form id="searchForm">
            <input type="text" id="query" name="query" placeholder="Zadejte název potraviny (např. jablko, kuře)">
            <button type="submit">Vyhledat</button>
        </form>

        <div id="loading">Vyhledávám...</div>
        <div id="error-message" class="error"></div>
        <div id="results">
            <!-- Zde se budou zobrazovat výsledky -->
        </div>
    </div>

    <!-- Modální okno pro detaily potravin -->
    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div id="modalDetailsContent" class="modal-details">
                <p class="loading-details">Načítám detaily...</p>
                <!-- Zde se načtou detaily -->
            </div>
        </div>
    </div>

    <!-- Nové modální okno pro možnosti receptů -->
    <div id="recipeOptionsModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="closeRecipeOptionsModal">&times;</span>
            <h3>Recepty</h3>
            <button id="createRecipe">Vytvořit nový recept</button>
            <button id="editRecipe">Upravit stávající recept</button>
            <button id="viewRecipes">Zobrazit seznam receptů</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            console.log('DOMContentLoaded fired.'); // Přidáno pro diagnostiku

            // --- Helper functions ---
            // Helper function to parse a value string (e.g., "7,34 g" or "1 000 kcal") into a number and its unit
            function parseValueAndUnit(valueString) {
                if (typeof valueString !== 'string' && typeof valueString !== 'number') {
                    return { number: NaN, unit: '' };
                }
                if (typeof valueString === 'number') {
                    return { number: valueString, unit: '' };
                }

                // First, remove all spaces (including non-breaking spaces) from the string.
                // Then, replace decimal commas with dots for parseFloat.
                const cleanedString = String(valueString).replace(/[\s\u00A0]/g, '').replace(',', '.');

                // Now, extract the numeric part and the unit.
                // The regex now expects a cleaned number format.
                const match = cleanedString.match(/(\d+\.?\d*)\s*(.*)/);
                if (match) {
                    const number = parseFloat(match[1]);
                    const unit = match[2] || '';
                    return { number, unit };
                }
                return { number: NaN, unit: '' };
            }

            // Helper function to format a number for display with locale-specific decimal comma and unit
            function formatNumberForDisplay(number, unit = '', isEnergyValue = false) {
                if (typeof number !== 'number' || isNaN(number) || number === null || number === undefined) {
                    return '-'; // Return '-' for non-numeric values
                }

                let formattedNumber;
                if (isEnergyValue) {
                    // Round to whole number for energy values (kcal, kJ)
                    formattedNumber = Math.round(number);
                } else {
                    // Round to 2 decimal places for all other values (nutrients)
                    formattedNumber = parseFloat(number.toFixed(2));
                }
                
                // Use toLocaleString for proper locale-specific formatting (handles thousands and decimals)
                // For Czech, it uses space for thousands and comma for decimal
                return `${formattedNumber.toLocaleString('cs-CZ')}${unit ? ` ${unit}` : ''}`;
            }

            // Function to create a single nutrient row HTML
            function createNutrientRow(label, originalValueString, rdiString = null, dotColor = null, type = 'other', currentFactor = 1, addSeparator = false, fontWeight = 'bold', fontSize = null) {
                const { number: originalNumericValue, unit: displayUnit } = parseValueAndUnit(originalValueString);

                let calculatedValueDisplay;
                if (isNaN(originalNumericValue)) {
                    calculatedValueDisplay = '-';
                } else {
                    calculatedValueDisplay = formatNumberForDisplay(originalNumericValue * currentFactor, displayUnit, false);
                }

                let dot = dotColor ? `<span class="dot ${dotColor}"></span>` : '';
                let labelClass = 'nutrient-label';
                let valueClass = 'nutrient-value';

                let labelStyle = `font-weight: ${fontWeight};`;
                let valueStyle = `font-weight: ${fontWeight};`;
                let separatorHtml = '';

                if (fontSize) {
                    labelStyle += `font-size: ${fontSize};`;
                    valueStyle += `font-size: ${fontSize};`;
                }

                if (dotColor) {
                    let colorHex = '';
                    switch (dotColor) {
                        case 'red': colorHex = '#f44336'; break;
                        case 'blue': colorHex = '#2196f3'; break;
                        case 'orange': colorHex = '#ff9800'; break;
                        case 'green': colorHex = '#4caf50'; break;
                        default: colorHex = '';
                    }
                    if (colorHex) {
                        labelStyle += `color: ${colorHex};`;
                        valueStyle += `color: ${colorHex};`;
                    }
                }

                if (type === 'main') {
                    labelClass += ' main';
                    valueClass += ' main-value';
                } else if (type === 'nested') {
                    labelClass = 'nutrient-sub-label';
                    valueClass = 'nutrient-sub-value';
                }

                if (addSeparator) {
                    separatorHtml = `<div class="nutrient-line-separator"></div>`;
                }

                // Removed RDI HTML generation as per user request
                let rdiHtml = ''; 

                return `
                    ${separatorHtml}
                    <div class="nutrient-row">
                        <div class="${labelClass}" style="${labelStyle}">${dot}${label}</div>
                        <div class="${valueClass}" style="${valueStyle}">${calculatedValueDisplay}</div>
                    </div>
                    ${rdiHtml}
                `;
            }

            // Function to render all nutrient details
            function renderAllNutrientDetails(details, factor = 1) {
                console.log("renderAllNutrientDetails called with details:", details, "factor:", factor);
                const nutrientDetailsSection = document.getElementById('nutrientDetailsSection');
                if (!nutrientDetailsSection) {
                    console.error("Element 'nutrientDetailsSection' not found. Cannot render nutrients.");
                    return;
                }
                nutrientDetailsSection.innerHTML = ''; // Clear previous content

                // Update energy display
                const totalKcalDisplay = document.getElementById('totalKcalDisplay');
                const totalKjDisplay = document.getElementById('totalKjDisplay');

                if (totalKcalDisplay) {
                    const { number: kcalNum, unit: kcalUnit } = parseValueAndUnit(details.total_kcal);
                    totalKcalDisplay.textContent = formatNumberForDisplay(kcalNum * factor, kcalUnit, true);
                }
                if (totalKjDisplay) {
                    const { number: kjNum, unit: kjUnit } = parseValueAndUnit(details.total_kj);
                    totalKjDisplay.textContent = `Také ${formatNumberForDisplay(kjNum * factor, kjUnit, true)} • Energetická hodnota`;
                }

                let nutrientsHtmlContent = '';

                // Section 1: Main Macronutrients
                nutrientsHtmlContent += `<div class="nutrient-section">`;
                // Add separator above Bílkoviny
                nutrientsHtmlContent += createNutrientRow('Bílkoviny', details.protein, null, 'red', 'main', factor, true);
                // Add separator above Sacharidy
                nutrientsHtmlContent += createNutrientRow('Sacharidy', details.carbs, null, 'blue', 'main', factor, true);
                nutrientsHtmlContent += createNutrientRow('Cukry', details.sugar, null, null, 'nested', factor, false);
                // Add separator above Tuky
                nutrientsHtmlContent += createNutrientRow('Tuky', details.fat, null, 'orange', 'main', factor, true);
                nutrientsHtmlContent += createNutrientRow('Nasycené mastné kyseliny', details.saturated_fat, null, null, 'nested', factor, false);
                nutrientsHtmlContent += createNutrientRow('Trans mastné kyseliny', details.trans_fat, null, null, 'nested', factor, false);
                nutrientsHtmlContent += createNutrientRow('Mononenasycené', details.monounsaturated_fat, null, null, 'nested', factor, false);
                nutrientsHtmlContent += createNutrientRow('Polynenasycené', details.polyunsaturated_fat, null, null, 'nested', factor, false);
                nutrientsHtmlContent += createNutrientRow('Cholesterol', details.cholesterol, null, null, 'nested', factor, false);
                nutrientsHtmlContent += `</div>`;

                // Section 2: Fiber
                nutrientsHtmlContent += `<div class="nutrient-section">`;
                nutrientsHtmlContent += createNutrientRow('Vláknina', details.fiber, null, 'green', 'main', factor, true); // Separator above Vláknina
                nutrientsHtmlContent += `</div>`;

                // Section 3: Minerals and Water (normal font, specific size)
                nutrientsHtmlContent += `<div class="nutrient-section">`;
                nutrientsHtmlContent += createNutrientRow('Sůl', details.salt, null, null, 'main', factor, true, 'normal', '1.05em'); // Separator above Sůl, normal font, 1.05em
                nutrientsHtmlContent += createNutrientRow('Vápník', details.calcium, null, null, 'main', factor, false, 'normal', '1.05em');
                nutrientsHtmlContent += createNutrientRow('Sodík', details.sodium, null, null, 'main', factor, false, 'normal', '1.05em');
                nutrientsHtmlContent += createNutrientRow('Voda', details.water, null, null, 'main', factor, false, 'normal', '1.05em');
                nutrientsHtmlContent += createNutrientRow('PHE', details.phe, null, null, 'main', factor, false, 'normal', '1.05em');
                nutrientsHtmlContent += `</div>`;

                nutrientDetailsSection.innerHTML = nutrientsHtmlContent;
                console.log("Nutrients rendered.");
            }


            // --- Logika vyhledávání potravin ---
            const searchForm = document.getElementById('searchForm'); // Get the form element
            if (searchForm) { // Check if the form element exists
                searchForm.addEventListener('submit', async function(event) {
                    console.log('Search form submit event fired.'); // Přidáno pro diagnostiku
                    event.preventDefault();

                    const query = document.getElementById('query').value;
                    const resultsDiv = document.getElementById('results');
                    const loadingDiv = document.getElementById('loading');
                    const errorDiv = document.getElementById('error-message');

                    resultsDiv.innerHTML = '';
                    errorDiv.innerHTML = '';
                    loadingDiv.style.display = 'block';

                    try {
                        const response = await fetch('/search', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `query=${encodeURIComponent(query)}`
                        });

                        if (!response.ok) {
                            loadingDiv.style.display = 'none';
                            let errorData;
                            try {
                                errorData = await response.json();
                            } catch (e) {
                                errorData = { error: await response.text() };
                            }
                            errorDiv.textContent = `Chyba: ${errorData.error || response.statusText}`;
                            return;
                        }

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder('utf-8');
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) {
                                break;
                            }

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop();

                            for (const line of lines) {
                                if (line.trim() === '') continue;
                                try {
                                    const item = JSON.parse(line);
                                    if (item.error) {
                                        errorDiv.textContent = `Chyba ze serveru: ${item.error}`;
                                        loadingDiv.style.display = 'none';
                                        return;
                                    }
                                    appendFoodItem(item);
                                } catch (e) {
                                    console.error('Chyba při parsování JSON řádku:', e, 'Řádek:', line);
                                }
                            }
                        }
                        if (buffer.trim() !== '') {
                            try {
                                const item = JSON.parse(buffer);
                                if (item.error) {
                                    errorDiv.textContent = `Chyba ze serveru: ${item.error}`;
                                } else {
                                    appendFoodItem(item);
                                }
                            } catch (e) {
                                console.error('Chyba při parsování zbytku JSON bufferu:', e, 'Buffer:', buffer);
                            }
                        }

                        loadingDiv.style.display = 'none';
                        if (resultsDiv.innerHTML === '') {
                            resultsDiv.innerHTML = '<p>Nic nenalezeno.</p>';
                        }

                    } catch (error) {
                        console.error('Došlo k chybě:', error);
                        loadingDiv.style.display = 'none';
                        errorDiv.textContent = 'Došlo k chybě při komunikaci se serverem.';
                    }
                });
            } else {
                console.error('Search form element with ID "searchForm" not found.'); // Přidáno pro diagnostiku
            }


            function appendFoodItem(item) {
                const resultsDiv = document.getElementById('results');
                const foodItemDiv = document.createElement('div');
                foodItemDiv.classList.add('food-item');

                // Add class based on food type for coloring the item background
                if (item.food_type === 'potravina') {
                    foodItemDiv.classList.add('food-item-potravina');
                } else if (item.food_type === 'recept') {
                    foodItemDiv.classList.add('food-item-recept');
                }


                if (item.slug) {
                    foodItemDiv.dataset.slug = item.slug;
                    foodItemDiv.dataset.foodType = item.food_type; // Uložíme food_type
                    foodItemDiv.addEventListener('click', () => showDetailsModal(item.slug, item.name, item.image_url, item.calories, item.food_type));
                }

                let imageHtml = '';
                const placeholderImage = 'https://placehold.co/60x60/cccccc/333333?text=Bez+obr.';

                if (item.image_url) {
                    imageHtml = `<img src="${item.image_url}" alt="${item.name}" onerror="this.onerror=null;this.src='${placeholderImage}'" />`;
                } else {
                     imageHtml = `<img src="${placeholderImage}" alt="Bez obrázku" />`;
                }

                let foodTypeLabelHtml = '';
                if (item.food_type) {
                    let labelClass = '';
                    if (item.food_type === 'potravina') {
                        labelClass = 'potravina-label';
                    } else if (item.food_type === 'recept') {
                        labelClass = 'recept-label';
                    }
                    foodTypeLabelHtml = `<div class="food-type-label ${labelClass}">${item.food_type}</div>`;
                }

                let itemContent = `
                    ${imageHtml}
                    <div class="food-details">
                        <h3>${item.name}</h3>
                        <p><strong>Kalorie:</strong> ${item.calories}</p>
                    </div>
                    ${foodTypeLabelHtml}
                `;
                foodItemDiv.innerHTML = itemContent;
                resultsDiv.appendChild(foodItemDiv);
            }

            // --- Logika modálního okna pro detaily potravin ---
            const detailsModal = document.getElementById('detailsModal');
            const closeButton = detailsModal.querySelector('.close-button');
            const modalDetailsContent = document.getElementById('modalDetailsContent');

            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    detailsModal.style.display = 'none';
                });
            }

            window.addEventListener('click', (event) => {
                if (event.target == detailsModal) {
                    detailsModal.style.display = 'none';
                }
            });

            async function showDetailsModal(slug, name, imageUrl, initialCaloriesString, foodType) {
                console.log("showDetailsModal called for slug:", slug, "name:", name, "foodType:", foodType);
                detailsModal.style.display = 'flex';
                modalDetailsContent.innerHTML = `<p class="loading-details">Načítám detaily pro ${name}...</p>`;

                try {
                    const response = await fetch('/get_details', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ slug: slug, food_type: foodType })
                    });

                    console.log("Response status:", response.status);

                    if (!response.ok) {
                        let errorMessage = `Chyba při načítání detailů (Status: ${response.status}).`;
                        let rawResponseText = await response.text();
                        console.error("Raw server response (not OK):", rawResponseText);
                        try {
                            const errorData = JSON.parse(rawResponseText); // Try parsing as JSON
                            if (errorData && errorData.error) {
                                errorMessage = `Chyba ze serveru: ${errorData.error}`;
                            } else {
                                errorMessage = `Chyba ze serveru (neznámý formát odpovědi).`;
                            }
                        } catch (jsonParseError) {
                            errorMessage = `Chyba při komunikaci se serverem: ${response.statusText || 'Neznámá chyba'}. Odpověď serveru nebyla platný JSON.`;
                            console.error("Nepodařilo se parsovat odpověď serveru jako JSON:", jsonParseError);
                        }
                        modalDetailsContent.innerHTML = `<p class="error-details">${errorMessage}</p>`;
                        return;
                    }

                    const details = await response.json();
                    console.log("Received details JSON:", details); // Log the received JSON
                    let originalDetailsData = details;

                    if (details.error) {
                        modalDetailsContent.innerHTML = `<p class="error-details">Chyba ze serveru: ${details.error}</p>`;
                    } else {
                        const placeholderImage = 'https://placehold.co/120x120/cccccc/333333?text=Bez+obr.';
                        let displayImageUrl = imageUrl || placeholderImage;

                        const { unit: initialUnitForTypeDetection } = parseValueAndUnit(initialCaloriesString);
                        const isLiquidFood = initialUnitForTypeDetection.toLowerCase().includes('ml');

                        let detailsHtml = `
                            <div class="modal-header-content">
                                <img id="modalHeaderImage" src="${displayImageUrl}" alt="${name}" class="modal-header-image" onerror="this.onerror=null;this.src='${placeholderImage}'" />
                                <div id="modalHeaderName" class="modal-header-name">${name}</div>
                            </div>
                            <div class="interactive-section">
                                <div class="amount-controls">
                                    <input type="number" id="amountInput" value="100" min="0" step="1" class="amount-input">
                                    <select id="unitSelect" class="unit-select">
                                        <!-- Options will be dynamically added here -->
                                    </select>
                                </div>
                                <div class="energy-display-group">
                                    <div id="totalKcalDisplay" class="energy-header"></div>
                                    <div id="totalKjDisplay" class="energy-sub-header"></div>
                                </div>
                            </div>
                            <div id="nutrientDetailsSection">
                                <!-- Nutrients will be rendered here by renderAllNutrientDetails -->
                            </div>
                            ${details.source_url ? `<p style="text-align: center; margin-top: 20px;"><a href="${details.source_url}" target="_blank">Zobrazit na KalorickéTabulky.cz</a></p>` : ''}
                        `;
                        modalDetailsContent.innerHTML = detailsHtml;

                        const amountInput = document.getElementById('amountInput');
                        const unitSelect = document.getElementById('unitSelect');

                        unitSelect.innerHTML = '';
                        if (isLiquidFood) {
                            unitSelect.add(new Option('ml', 'ml'));
                            unitSelect.add(new Option('l', 'l'));
                            unitSelect.value = 'ml';
                        } else {
                            unitSelect.add(new Option('g', 'g'));
                            unitSelect.add(new Option('kg', 'kg'));
                            unitSelect.value = 'g';
                        }

                        const updateDisplay = () => {
                            const currentAmount = parseFloat(amountInput.value) || 0;
                            const selectedUnit = unitSelect.value;
                            let baseAmount = currentAmount;

                            if (selectedUnit === 'kg') {
                                baseAmount = currentAmount * 1000;
                            } else if (selectedUnit === 'l') {
                                baseAmount = currentAmount * 1000;
                            }

                            let factor = baseAmount / 100;

                            renderAllNutrientDetails(originalDetailsData, factor);
                        };

                        amountInput.addEventListener('input', updateDisplay);
                        unitSelect.addEventListener('change', updateDisplay);

                        // Initial render of nutrients
                        updateDisplay(); // Call updateDisplay to render with initial 100g/ml

                        const modalHeaderImage = document.getElementById('modalHeaderImage');
                        const modalHeaderName = document.getElementById('modalHeaderName');

                        if (modalHeaderImage && modalHeaderName) {
                            const imageHeight = modalHeaderImage.offsetHeight;
                            let currentFontSize = imageHeight * 0.25;
                            modalHeaderName.style.fontSize = `${currentFontSize}px`;

                            while ((modalHeaderName.scrollWidth > modalHeaderName.clientWidth || modalHeaderName.scrollHeight > modalHeaderName.clientHeight) && currentFontSize > 10) {
                                currentFontSize -= 0.5;
                                modalHeaderName.style.fontSize = `${currentFontSize}px`;
                            }
                        }
                    }

                } catch (error) {
                    console.error('Chyba při získávání detailů:', error);
                    modalDetailsContent.innerHTML = `<p class="error-details">Došlo k chybě při komunikaci se serverem pro detaily.</p>`;
                }
            }
        });

        // --- Logika pro tlačítko "Recepty" a modální okno s možnostmi receptů ---
        const recipesButton = document.getElementById('recipesButton');
        const recipeOptionsModal = document.getElementById('recipeOptionsModal');
        const closeRecipeOptionsModalButton = document.getElementById('closeRecipeOptionsModal');

        if (recipesButton && recipeOptionsModal && closeRecipeOptionsModalButton) {
            recipesButton.addEventListener('click', () => {
                recipeOptionsModal.style.display = 'flex';
            });

            closeRecipeOptionsModalButton.addEventListener('click', () => {
                recipeOptionsModal.style.display = 'none';
            });

            window.addEventListener('click', (event) => {
                if (event.target == recipeOptionsModal) {
                    recipeOptionsModal.style.display = 'none';
                }
            });

            // Add event listeners for the recipe option buttons (currently just console logs)
            document.getElementById('createRecipe').addEventListener('click', () => {
                console.log('Vytvořit nový recept clicked');
                // Implement logic to create new recipe
                recipeOptionsModal.style.display = 'none'; // Close modal after click
            });

            document.getElementById('editRecipe').addEventListener('click', () => {
                console.log('Upravit stávající recept clicked');
                // Implement logic to edit existing recipe
                recipeOptionsModal.style.display = 'none'; // Close modal after click
            });

            document.getElementById('viewRecipes').addEventListener('click', () => {
                console.log('Zobrazit seznam receptů clicked');
                // Implement logic to show recipe list
                recipeOptionsModal.style.display = 'none'; // Close modal after click
            });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalorické Tabulky - Studijní Vyhledávač</title>
    <style>
        body {
            font-family: 'Dutch801 Rm BT', serif; /* Změna písma na Dutch801 Rm BT */
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container { max-width: 800px; margin: auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        form { display: flex; justify-content: center; margin-bottom: 20px; }
        input[type="text"] { padding: 10px; width: 60%; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-left: 10px; }
        button:hover { background-color: #0056b3; }
        #results { margin-top: 20px; }
        .food-item {
            background-color: #e9e9e9;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .food-item:hover {
            background-color: #e0e0e0;
        }
        .food-item h3 { margin: 0 0 5px 0; color: #007bff; }
        .food-item p { margin: 0; font-size: 0.9em; color: #555; }
        .food-item img {
            width: 60px;
            height: 60px;
            margin-right: 15px;
            object-fit: contain;
            border-radius: 4px;
        }
        .food-details {
            flex-grow: 1;
        }
        #loading { display: none; text-align: center; color: #888; }
        .error { color: red; text-align: center; margin-top: 10px; }
        .warning { color: orange; text-align: center; margin-top: 10px; font-size: 0.9em; }

        /* Styly pro modální okno */
        .modal-overlay {
            display: none; /* Skryté ve výchozím stavu */
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px; /* Ponecháno 20px pro vnitřní odsazení obsahu */
            border: 1px solid #888;
            width: 80%; /* Původní šířka */
            max-width: 350px; /* Zúžení o cca 1/3 z 500px */
            border-radius: 8px;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .close-button {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 3px; /* Posunuto nahoru o 7px (z 10px na 3px) */
            right: 13px; /* Posunuto doprava o 7px (z 20px na 13px) */
            cursor: pointer;
            padding: 0; /* Zajištění, že aktivní oblast odpovídá vizuálnímu křížku */
            line-height: 1; /* Zajištění, že aktivní oblast odpovídá vizuálnímu křížku */
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-details {
            font-size: 0.95em;
        }
        .modal-details h3 {
            margin-top: 15px;
            margin-bottom: 5px;
            color: #333;
            font-size: 1.1em;
        }
        .modal-details p {
            margin-bottom: 3px;
        }
        .modal-details strong {
            color: #333;
        }
        .modal-details .loading-details, .modal-details .error-details {
            text-align: center;
            color: #888;
            margin-top: 10px;
        }
        .modal-details .error-details {
            color: red;
        }

        /* Styly pro zobrazení jako na obrázku */
        .nutrient-section {
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .nutrient-section:last-child {
            border-bottom: none;
        }
        .nutrient-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 2px;
        }
        .nutrient-label {
            display: flex;
            align-items: center;
            font-weight: bold;
            /* Barva bude nastavena inline pomocí JS */
        }
        .nutrient-label.main {
            font-size: 1.2em; /* Zvětšená velikost písma */
        }
        .nutrient-value {
            font-weight: bold;
            /* Barva bude nastavena inline pomocí JS */
        }
        .nutrient-value.main-value {
            font-size: 1.2em; /* Zvětšená velikost písma */
        }
        .nutrient-sub-label {
            margin-left: 20px; /* Odsazení pro podkategorie */
            font-size: 0.9em;
            color: #555;
        }
        .nutrient-sub-value {
             font-size: 0.9em;
             color: #555;
        }
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
        }
        .dot.red { background-color: #f44336; }
        .dot.blue { background-color: #2196f3; }
        .dot.orange { background-color: #ff9800; }
        .dot.green { background-color: #4caf50; } /* Pro Vlákninu */

        .energy-header {
            text-align: right; /* Zarovnání k pravému okraji */
            font-size: 2.1em; /* Zvětšená velikost písma o 3 body (z 1.8em na 2.1em) */
            font-weight: bold;
            margin-bottom: 5px;
        }
        .energy-sub-header {
            text-align: right; /* Zarovnání k pravému okraji */
            font-size: 0.9em;
            color: #777;
            margin-bottom: 0; /* Odstraněna spodní mezera pro přesnější zarovnání */
            white-space: nowrap; /* Zabrání rozdělení textu na více řádků */
        }

        /* Nové styly pro hlavičku detailu */
        .modal-header-content {
            display: flex; /* Použijeme flexbox */
            align-items: center; /* Vertikálně vycentrujeme položky */
            margin-bottom: 20px;
        }
        .modal-header-image {
            width: 120px; /* Zvětšená velikost obrázku a čtvercový tvar */
            height: 120px; /* Zvětšená velikost obrázku a čtvercový tvar */
            object-fit: cover; /* Oříznutí namísto deformace */
            margin-right: 15px;
            border-radius: 8px; /* Zaoblené rohy, odpovídající modálnímu oknu */
            flex-shrink: 0; /* Zabrání zmenšování obrázku */
        }
        .modal-header-name {
            flex-grow: 1; /* Povolí názvu zabrat dostupný prostor */
            flex-shrink: 1; /* Povolí názvu se zmenšit, pokud je potřeba */
            font-weight: bold;
            color: #333;
            text-align: center;
            line-height: 1.2;
            overflow: hidden; /* Skryje přetečení textu */
            display: flex; /* Použijeme flexbox pro vertikální centrování textu uvnitř divu */
            align-items: center; /* Vertikálně vycentruje text */
            justify-content: center; /* Horizontálně vycentruje text */
            height: 120px; /* Omezí výšku na výšku obrázku */
        }

        /* Nový kontejner pro interaktivní sekci (množství/jednotka a kalorie/kJ) */
        .interactive-section {
            display: flex;
            justify-content: space-between; /* Rozprostře položky na kraje */
            align-items: flex-end; /* Zarovná položky dole */
            margin-bottom: 15px;
            padding-left: 10px; /* Odsazení 10px od levého okraje */
            padding-right: 0; /* Změněno na 0 odsazení od pravého okraje */
        }

        /* Styly pro pole množství a jednotek */
        .amount-controls {
            display: flex; /* Použijeme flexbox */
            flex-direction: column; /* Položky pod sebou */
            align-items: flex-start; /* Zarovná položky doleva */
            gap: 10px; /* Mezera mezi inputem a selectem */
            flex-shrink: 0; /* Zabrání zmenšování */
        }

        .amount-input, .unit-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px; /* Zaoblení okrajů */
            font-family: 'Dutch801 Rm BT', serif; /* Změna písma */
            box-sizing: border-box; /* Zahrnuje padding a border do výpočtu šířky */
        }

        .amount-input {
            width: 100px; /* Šířka 100px */
            font-size: 1.3em; /* Zvětšené písmo */
            text-align: left; /* Zarovnání textu doleva */
        }

        .unit-select {
            width: 60px; /* Zmenšeno na polovinu */
            font-size: 0.8em; /* Zmenšené písmo */
            appearance: none; /* Odstranit výchozí šipku selectu */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="%23333" viewBox="0 0 10 10"><path d="M0 2.5 L5 7.5 L10 2.5 Z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 8px;
            margin: 0; /* Odstraněno automatické vycentrování */
        }

        /* Kontejner pro energetické hodnoty */
        .energy-display-group {
            flex-grow: 1; /* Povolí zabrat zbývající prostor */
            text-align: right; /* Zarovnání obsahu doprava */
            display: flex; /* Povolí flexbox pro zarovnání obsahu */
            flex-direction: column; /* Položky pod sebou */
            justify-content: flex-end; /* Zarovná obsah na konec (dole) */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Studijní Vyhledávač Potravin (Kalorické Tabulky)</h1>
        <p>
            <strong>Upozornění:</strong> Tato aplikace je určena pouze pro studijní účely a demonstruje principy web scrapingu/API volání.
            Nepoužívá oficiální dokumentované API Kalorických Tabulek. Data jsou omezena na název a kalorie, protože tato URL neposkytuje detailní nutriční hodnoty.
            Používání takových metod může být v rozporu s podmínkami použití webu. Buďte opatrní a respektujte pravidla.
        </p>

        <form id="searchForm">
            <input type="text" id="query" name="query" placeholder="Zadejte název potraviny (např. jablko, kuře)">
            <button type="submit">Vyhledat</button>
        </form>

        <div id="loading">Vyhledávám...</div>
        <div id="error-message" class="error"></div>
        <div id="results">
            <!-- Zde se budou zobrazovat výsledky -->
        </div>
    </div>

    <!-- Modální okno pro detaily -->
    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div id="modalDetailsContent" class="modal-details">
                <p class="loading-details">Načítám detaily...</p>
                <!-- Zde se načtou detaily -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => { // Zajištění, že se skript spustí až po načtení DOM
            document.getElementById('searchForm').addEventListener('submit', async function(event) {
                event.preventDefault();

                const query = document.getElementById('query').value;
                const resultsDiv = document.getElementById('results');
                const loadingDiv = document.getElementById('loading');
                const errorDiv = document.getElementById('error-message');

                resultsDiv.innerHTML = '';
                errorDiv.innerHTML = '';
                loadingDiv.style.display = 'block';

                try {
                    const response = await fetch('/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `query=${encodeURIComponent(query)}`
                    });

                    if (!response.ok) {
                        loadingDiv.style.display = 'none';
                        let errorData;
                        try {
                            errorData = await response.json();
                        } catch (e) {
                            errorData = { error: await response.text() };
                        }
                        errorDiv.textContent = `Chyba: ${errorData.error || response.statusText}`;
                        return;
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) {
                            break;
                        }

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();

                        for (const line of lines) {
                            if (line.trim() === '') continue;
                            try {
                                const item = JSON.parse(line);
                                if (item.error) {
                                    errorDiv.textContent = `Chyba ze serveru: ${item.error}`;
                                    loadingDiv.style.display = 'none';
                                    return;
                                }
                                appendFoodItem(item);
                            } catch (e) {
                                console.error('Chyba při parsování JSON řádku:', e, 'Řádek:', line);
                            }
                        }
                    }
                    if (buffer.trim() !== '') {
                        try {
                            const item = JSON.parse(buffer);
                            if (item.error) {
                                errorDiv.textContent = `Chyba ze serveru: ${item.error}`;
                            } else {
                                appendFoodItem(item);
                            }
                        } catch (e) {
                            console.error('Chyba při parsování zbytku JSON bufferu:', e, 'Buffer:', buffer);
                        }
                    }

                    loadingDiv.style.display = 'none';
                    if (resultsDiv.innerHTML === '') {
                        resultsDiv.innerHTML = '<p>Nic nenalezeno.</p>';
                    }

                } catch (error) {
                    console.error('Došlo k chybě:', error);
                    loadingDiv.style.display = 'none';
                    errorDiv.textContent = 'Došlo k chybě při komunikaci se serverem.';
                }
            });

            function appendFoodItem(item) {
                const resultsDiv = document.getElementById('results');
                const foodItemDiv = document.createElement('div');
                foodItemDiv.classList.add('food-item');

                if (item.slug) {
                    foodItemDiv.dataset.slug = item.slug;
                    // Pass item.calories to showDetailsModal to determine initial unit type
                    foodItemDiv.addEventListener('click', () => showDetailsModal(item.slug, item.name, item.image_url, item.calories));
                }

                let imageHtml = '';
                const placeholderImage = 'https://placehold.co/60x60/cccccc/333333?text=Bez+obr.';

                if (item.image_url) {
                    imageHtml = `<img src="${item.image_url}" alt="${item.name}" onerror="this.onerror=null;this.src='${placeholderImage}'" />`;
                } else {
                     imageHtml = `<img src="${placeholderImage}" alt="Bez obrázku" />`;
                }

                let itemContent = `
                    ${imageHtml}
                    <div class="food-details">
                        <h3>${item.name}</h3>
                        <p><strong>Kalorie:</strong> ${item.calories}</p>
                    </div>
                `;
                foodItemDiv.innerHTML = itemContent;
                resultsDiv.appendChild(foodItemDiv);
            }

            // Logika modálního okna
            const detailsModal = document.getElementById('detailsModal');
            const closeButton = document.querySelector('.close-button');
            const modalDetailsContent = document.getElementById('modalDetailsContent');

            console.log("Close button element:", closeButton); // Zkontrolujeme, zda byl element nalezen

            // Přidán console.log pro ladění
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    console.log("Close button clicked!");
                    detailsModal.style.display = 'none';
                });
            } else {
                console.error("Close button element not found!");
            }


            window.addEventListener('click', (event) => {
                if (event.target == detailsModal) {
                    console.log("Clicked outside modal, closing."); // Přidán console.log
                    detailsModal.style.display = 'none';
                }
            });

            // Helper function to parse a value string (e.g., "7,34 g" or "1 000 kcal") into a number and its unit
            function parseValueAndUnit(valueString) {
                if (typeof valueString !== 'string' && typeof valueString !== 'number') {
                    return { number: NaN, unit: '' };
                }
                if (typeof valueString === 'number') {
                    return { number: valueString, unit: '' };
                }

                // First, remove all spaces from the string.
                // Then, replace decimal commas with dots for parseFloat.
                const cleanedString = String(valueString).replace(/\s/g, '').replace(',', '.');

                // Now, extract the numeric part and the unit.
                // The regex now expects a cleaned number format.
                const match = cleanedString.match(/(\d+\.?\d*)\s*(.*)/);
                if (match) {
                    const number = parseFloat(match[1]);
                    const unit = match[2] || '';
                    return { number, unit };
                }
                return { number: NaN, unit: '' };
            }

            // Helper function to format a number for display with locale-specific decimal comma and unit
            function formatNumberForDisplay(number, unit = '', isEnergyValue = false) { // Removed isRecalculated, added isEnergyValue
                if (typeof number !== 'number' || isNaN(number) || number === null || number === undefined) {
                    return '-'; // Return '-' for non-numeric values
                }

                let formattedNumber;
                if (isEnergyValue) {
                    // Round to whole number for energy values (kcal, kJ)
                    formattedNumber = Math.round(number).toString().replace('.', ',');
                } else {
                    // Round to 2 decimal places for all other values (nutrients)
                    formattedNumber = number.toFixed(2).replace('.', ',');
                }

                return `${formattedNumber}${unit ? ` ${unit}` : ''}`;
            }

            async function showDetailsModal(slug, name, imageUrl, initialCaloriesString) { // Added initialCaloriesString
                detailsModal.style.display = 'flex';
                modalDetailsContent.innerHTML = `<p class="loading-details">Načítám detaily pro ${name}...</p>`;

                try {
                    const response = await fetch('/get_details', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ slug: slug })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        modalDetailsContent.innerHTML = `<p class="error-details">Chyba při načítání detailů: ${errorData.error || response.statusText}</p>`;
                        return;
                    }

                    const details = await response.json();
                    // Store the original details (strings with units) for recalculation
                    let originalDetailsData = details;

                    if (details.error) {
                        modalDetailsContent.innerHTML = `<p class="error-details">Chyba ze serveru: ${details.error}</p>`;
                    } else {
                        const placeholderImage = 'https://placehold.co/120x120/cccccc/333333?text=Bez+obr.';
                        let displayImageUrl = imageUrl || placeholderImage;

                        // Determine if the food is liquid based on the unit in initialCaloriesString
                        const { unit: initialUnitForTypeDetection } = parseValueAndUnit(initialCaloriesString);
                        const isLiquidFood = initialUnitForTypeDetection.toLowerCase().includes('ml');

                        // Function to generate nutrient rows
                        // originalValueString and rdiString are expected to be strings like "7,34 g" or "N/A"
                        function createNutrientRow(label, originalValueString, rdiString = null, dotColor = null, type = 'other', currentFactor = 1) { // Removed isRecalculated
                            const { number: originalNumericValue, unit: displayUnit } = parseValueAndUnit(originalValueString);

                            let calculatedValueDisplay;
                            if (isNaN(originalNumericValue)) {
                                calculatedValueDisplay = '-';
                            } else {
                                // For nutrient rows, isEnergyValue is always false
                                calculatedValueDisplay = formatNumberForDisplay(originalNumericValue * currentFactor, displayUnit, false);
                            }

                            let dot = dotColor ? `<span class="dot ${dotColor}"></span>` : '';
                            let labelClass = 'nutrient-label';
                            let valueClass = 'nutrient-value';
                            let valueId = `nutrient-${label.replace(/\s+/g, '-').toLowerCase()}`; // Unique ID for each nutrient value

                            let labelStyle = '';
                            let valueStyle = '';
                            let colorHex = '';

                            if (dotColor) {
                                switch (dotColor) {
                                    case 'red': colorHex = '#f44336'; break;
                                    case 'blue': colorHex = '#2196f3'; break;
                                    case 'orange': colorHex = '#ff9800'; break;
                                    case 'green': colorHex = '#4caf50'; break;
                                    default: colorHex = '';
                                }
                                if (colorHex) {
                                    labelStyle = `color: ${colorHex};`;
                                    valueStyle = `color: ${colorHex};`;
                                }
                            }

                            if (type === 'main') {
                                labelClass += ' main';
                                valueClass += ' main-value';
                            } else if (type === 'nested') {
                                labelClass = 'nutrient-sub-label';
                                valueClass = 'nutrient-sub-value';
                            }

                            return `
                                <div class="nutrient-row">
                                    <div class="${labelClass}" style="${labelStyle}">${dot}${label}</div>
                                    <div id="${valueId}" class="${valueClass}" style="${valueStyle}">${calculatedValueDisplay}</div>
                                </div>
                            `;
                        }

                        // Initial HTML structure
                        let detailsHtml = `
                            <div class="modal-header-content">
                                <img id="modalHeaderImage" src="${displayImageUrl}" alt="${name}" class="modal-header-image" onerror="this.onerror=null;this.src='${placeholderImage}'" />
                                <div id="modalHeaderName" class="modal-header-name">${name}</div>
                            </div>
                            <div class="interactive-section">
                                <div class="amount-controls">
                                    <input type="number" id="amountInput" value="100" min="0" step="1" class="amount-input">
                                    <select id="unitSelect" class="unit-select">
                                        <!-- Options will be dynamically added here -->
                                    </select>
                                </div>
                                <div class="energy-display-group">
                                    <div id="totalKcalDisplay" class="energy-header">${formatNumberForDisplay(parseValueAndUnit(details.total_kcal).number, parseValueAndUnit(details.total_kcal).unit, true)}</div>
                                    <div id="totalKjDisplay" class="energy-sub-header">Také ${formatNumberForDisplay(parseValueAndUnit(details.total_kj).number, parseValueAndUnit(details.total_kj).unit, true)} • Energetická hodnota</div>
                                </div>
                            </div>
                            <div id="nutrientDetailsSection">
                                <!-- Nutrients will be rendered here -->
                            </div>
                            ${details.source_url ? `<p style="text-align: center; margin-top: 20px;"><a href="${details.source_url}" target="_blank">Zobrazit na KalorickéTabulky.cz</a></p>` : ''}
                        `;
                        modalDetailsContent.innerHTML = detailsHtml;

                        // Get references to elements after they are added to DOM
                        const amountInput = document.getElementById('amountInput');
                        const unitSelect = document.getElementById('unitSelect');

                        // Dynamically populate unit options based on food type
                        unitSelect.innerHTML = ''; // Clear existing options
                        if (isLiquidFood) {
                            unitSelect.add(new Option('ml', 'ml'));
                            unitSelect.add(new Option('l', 'l'));
                            unitSelect.value = 'ml'; // Set default to ml
                        } else {
                            unitSelect.add(new Option('g', 'g'));
                            unitSelect.add(new Option('kg', 'kg'));
                            unitSelect.value = 'g'; // Set default to g
                        }


                        const updateDisplay = () => {
                            const currentAmount = parseFloat(amountInput.value) || 0;
                            const selectedUnit = unitSelect.value;
                            let baseAmount = currentAmount; // This will be the amount in grams/ml

                            // Convert currentAmount to base units (grams or milliliters)
                            if (selectedUnit === 'kg') {
                                baseAmount = currentAmount * 1000; // 1 kg = 1000 g
                            } else if (selectedUnit === 'l') {
                                baseAmount = currentAmount * 1000; // 1 l = 1000 ml. This is standard conversion.
                            }
                            // If 'g' or 'ml' are selected, baseAmount is already correct.

                            let factor = baseAmount / 100; // Factor relative to the 100-unit base data from API

                            renderAllNutrientDetails(originalDetailsData, factor); // No isRecalculated needed here, handled by formatNumberForDisplay
                        };

                        amountInput.addEventListener('input', updateDisplay);
                        unitSelect.addEventListener('change', updateDisplay); // Enable unit conversion logic

                        // Render initial nutrient details after setting up units and event listeners
                        renderAllNutrientDetails(originalDetailsData, 1); // Initial factor is 1 (for 100 units)


                        // Function to render all nutrient details
                        function renderAllNutrientDetails(details, currentFactor) { // Removed isRecalculated from signature
                            let nutrientsHtml = '';

                            nutrientsHtml += `<div class="nutrient-section">`;
                            nutrientsHtml += createNutrientRow('Bílkoviny', details.protein, details.protein_rdi, 'red', 'main', currentFactor);
                            nutrientsHtml += `</div>`;

                            nutrientsHtml += `<div class="nutrient-section">`;
                            nutrientsHtml += createNutrientRow('Sacharidy', details.carbs, details.carbs_rdi, 'blue', 'main', currentFactor);
                            nutrientsHtml += createNutrientRow('Cukry', details.sugar, null, null, 'nested', currentFactor);
                            nutrientsHtml += `</div>`;

                            nutrientsHtml += `<div class="nutrient-section">`;
                            nutrientsHtml += createNutrientRow('Tuky', details.fat, details.fat_rdi, 'orange', 'main', currentFactor);
                            nutrientsHtml += createNutrientRow('Nasycené mastné kyseliny', details.saturated_fat, null, null, 'nested', currentFactor);
                            nutrientsHtml += createNutrientRow('Trans mastné kyseliny', details.trans_fat, null, null, 'nested', currentFactor);
                            nutrientsHtml += createNutrientRow('Mononenasycené', details.monounsaturated_fat, null, null, 'nested', currentFactor);
                            nutrientsHtml += createNutrientRow('Polynenasycené', details.polyunsaturated_fat, null, null, 'nested', currentFactor);
                            nutrientsHtml += createNutrientRow('Cholesterol', details.cholesterol, null, null, 'nested', currentFactor);
                            nutrientsHtml += `</div>`;

                            nutrientsHtml += `<div class="nutrient-section">`;
                            nutrientsHtml += createNutrientRow('Vláknina', details.fiber, details.fiber_rdi, 'green', 'main', currentFactor);
                            nutrientsHtml += `</div>`;

                            nutrientsHtml += `<div class="nutrient-section">`;
                            nutrientsHtml += createNutrientRow('Sůl', details.salt, null, null, 'other', currentFactor);
                            nutrientsHtml += `</div>`;

                            nutrientsHtml += `<div class="nutrient-section">`;
                            nutrientsHtml += createNutrientRow('Vápník', details.calcium, null, null, 'other', currentFactor);
                            nutrientsHtml += `</div>`;

                            nutrientsHtml += `<div class="nutrient-section">`;
                            nutrientsHtml += createNutrientRow('Sodík', details.sodium, null, null, 'other', currentFactor);
                            nutrientsHtml += `</div>`;

                            nutrientsHtml += `<div class="nutrient-section">`;
                            nutrientsHtml += createNutrientRow('Voda', details.water, null, null, 'other', currentFactor);
                            nutrientsHtml += `</div>`;

                            nutrientsHtml += `<div class="nutrient-section">`;
                            nutrientsHtml += createNutrientRow('PHE', details.phe, null, null, 'other', currentFactor);
                            nutrientsHtml += `</div>`;

                            // Update the energy display directly
                            const { number: kcalNum, unit: kcalUnit } = parseValueAndUnit(details.total_kcal);
                            document.getElementById('totalKcalDisplay').textContent = formatNumberForDisplay(kcalNum * currentFactor, kcalUnit, true); // isEnergyValue is true

                            const { number: kjNum, unit: kjUnit } = parseValueAndUnit(details.total_kj);
                            document.getElementById('totalKjDisplay').textContent = `Také ${formatNumberForDisplay(kjNum * currentFactor, kjUnit, true)} • Energetická hodnota`; // isEnergyValue is true

                            // Update the dedicated nutrient display section
                            document.getElementById('nutrientDetailsSection').innerHTML = nutrientsHtml;
                        }

                        // Dynamické nastavení velikosti písma a pozice názvu po vložení HTML
                        const modalHeaderImage = document.getElementById('modalHeaderImage');
                        const modalHeaderName = document.getElementById('modalHeaderName');

                        if (modalHeaderImage && modalHeaderName) {
                            const imageHeight = modalHeaderImage.offsetHeight;
                            let currentFontSize = imageHeight * 0.25; // Inicializujeme na 25% výšky obrázku
                            modalHeaderName.style.fontSize = `${currentFontSize}px`;

                            // Iterativně zmenšujeme font-size, dokud se text nevejde
                            // Kontrolujeme jak šířku, tak výšku
                            while ((modalHeaderName.scrollWidth > modalHeaderName.clientWidth || modalHeaderName.scrollHeight > modalHeaderName.clientHeight) && currentFontSize > 10) { // Minimální velikost písma 10px
                                currentFontSize -= 0.5; // Zmenšujeme po 0.5px
                                modalHeaderName.style.fontSize = `${currentFontSize}px`;
                            }
                        }
                    }

                } catch (error) {
                    console.error('Chyba při získávání detailů:', error);
                    modalDetailsContent.innerHTML = `<p class="error-details">Došlo k chybě při komunikaci se serverem pro detaily.</p>`;
                }
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalorick칠 Tabulky - Studijn칤 Vyhled치va캜</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Styly pro skenov치n칤 캜치rov칳ch k칩d콢 */
        .barcode-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .barcode-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .barcode-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .barcode-video-container {
            position: relative;
            width: 100%;
            margin: 20px 0;
        }
        
        #barcodeVideo {
            width: 100%;
            border-radius: 8px;
            background: #000;
        }
        
        .barcode-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 30%;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            pointer-events: none;
        }
        
        .barcode-scanner-line {
            position: absolute;
            height: 2px;
            width: 100%;
            background: #4CAF50;
            animation: scan 2s infinite ease-in-out;
        }
        
        @keyframes scan {
            0% { top: 0; }
            50% { top: calc(100% - 2px); }
            100% { top: 0; }
        }
        
        .barcode-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .barcode-btn {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .barcode-btn:hover {
            background-color: #45a049;
        }
        
        .barcode-btn.secondary {
            background-color: #f44336;
        }
        
        .barcode-btn.secondary:hover {
            background-color: #d32f2f;
        }
        
        .barcode-manual-input {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .barcode-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .barcode-status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .barcode-status.error {
            background-color: #ffebee;
            color: #d32f2f;
            border: 1px solid #f44336;
        }
        
        .barcode-status.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #4CAF50;
        }
        
        .barcode-status.info {
            background-color: #e3f2fd;
            color: #1565c0;
            border: 1px solid #2196f3;
        }
    </style>
</head>
<body data-app-id="{{ app_id }}" data-firebase-config="{{ firebase_config_json }}">
    <div class="container">
        <!-- Zbytek va코eho k칩du z콢st치v치 stejn칳 -->
        <div class="sticky-header-wrapper">
            <div id="userIdDisplay"></div>
            <h1>Kalorick치 kalkula캜ka</h1>
            <img id="settingsIcon" src="{{ url_for('static', filename='icon/nastaveni.png') }}" alt="Nastaven칤" class="settings-icon">
            
            <div class="search-and-recipes-container">
                <div class="main-controls">
                    <button id="recipesButton" disabled>Recepty</button>
                    <button id="barcodeButton" style="margin-left: 10px;">
                        游닝 Skenovat k칩d
                    </button>
                </div>
                
                <form id="searchForm">
                    <input type="text" id="query" name="query" placeholder="Zadejte n치zev potraviny (nap콏. jablko, ku콏e)">
                    <button type="submit">Vyhledat</button>
                </form>
            </div>
            
            <div id="loading">Vyhled치v치m...</div>
            <div id="error-message" class="error"></div>
        </div>
        
        <div id="results">
            <!-- Zde se budou zobrazovat v칳sledky -->
        </div>
    </div>
    
    <!-- Mod치ln칤 okno pro skenov치n칤 캜치rov칳ch k칩d콢 -->
    <div id="barcodeModal" class="barcode-modal">
        <div class="barcode-modal-content">
            <span class="barcode-close" id="closeBarcodeModal">&times;</span>
            <h3>Skenovat 캜치rov칳 k칩d</h3>
            
            <div id="barcodeUnsupportedMessage" class="barcode-status info">
                <p>游 Skenov치n칤 캜치rov칳ch k칩d콢 nen칤 v tomto prohl칤쬰캜i dostupn칠</p>
                <p>Pro skenov치n칤 k칩d콢 fotoapar치tem:</p>
                <ul>
                    <li>Pou쬴jte HTTPS p콏ipojen칤 (zabezpe캜en칠)</li>
                    <li>Povolte p콏칤stup ke kame콏e v prohl칤쬰캜i</li>
                    <li>Zkuste modern칤 prohl칤쬰캜 (Chrome, Firefox, Edge)</li>
                </ul>
            </div>
            
            <div id="barcodeScannerContainer">
                <div class="barcode-video-container">
                    <video id="barcodeVideo" autoplay playsinline></video>
                    <div class="barcode-overlay">
                        <div class="barcode-scanner-line"></div>
                    </div>
                </div>
                
                <div id="barcodeStatus" class="barcode-status"></div>
                
                <div class="barcode-controls">
                    <button id="toggleCameraButton" class="barcode-btn">P콏epnout kameru</button>
                    <button id="toggleFlashButton" class="barcode-btn">Blesk</button>
                </div>
                
                <div class="barcode-manual-input">
                    <p>M콢쬰te tak칠 zadat k칩d ru캜n캩:</p>
                    <input type="text" id="manualBarcodeInput" class="barcode-input" placeholder="Zadejte 캜치rov칳 k칩d">
                    <button id="submitManualBarcode" class="barcode-btn">Vyhledat</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Zbytek va코ich mod치ln칤ch oken -->
    <div id="detailsModal" class="modal-overlay">
        <!-- ... -->
    </div>
    
    <script type="module">
        // Firebase imports a inicializace
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, where, getDocs, deleteDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // V치코 existuj칤c칤 k칩d pro Firebase inicializaci
        const bodyElement = document.body;
        const appId = bodyElement.dataset.appId;
        const firebaseConfigString = bodyElement.dataset.firebaseConfig;
        
        let firebaseConfig = {};
        try {
            firebaseConfig = JSON.parse(firebaseConfigString);
        } catch (e) {
            console.error("Error parsing firebaseConfigString:", e);
        }
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let app, db, auth, userId;
        let isAuthReady = false;
        
        // Prom캩nn칠 pro skenov치n칤 캜치rov칳ch k칩d콢
        let barcodeScannerActive = false;
        let stream = null;
        let currentDeviceId = null;
        let facingMode = 'environment';
        let flashEnabled = false;
        let barcodeDetector = null;
        let scanInterval = null;
        
        // Inicializace aplikace
        const initializeFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId || !firebaseConfig.apiKey) {
                    throw new Error("Firebase konfigurace je pr치zdn치 nebo neplatn치.");
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth Ready. User ID:", userId);
                    } else {
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                            } catch (error) {
                                console.error("Error signing in with custom token:", error);
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                            }
                        } else {
                            await signInAnonymously(auth);
                            userId = auth.currentUser.uid;
                        }
                    }
                    isAuthReady = true;
                    document.getElementById('userIdDisplay').textContent = `U쬴vatel ID: ${userId}`;
                    document.getElementById('recipesButton').disabled = false;
                    
                    // Inicializace skeneru 캜치rov칳ch k칩d콢
                    initBarcodeScanner();
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        };
        
        // Funkce pro skenov치n칤 캜치rov칳ch k칩d콢
        function initBarcodeScanner() {
            const barcodeModal = document.getElementById('barcodeModal');
            const barcodeVideo = document.getElementById('barcodeVideo');
            const closeBarcodeModal = document.getElementById('closeBarcodeModal');
            const toggleCameraButton = document.getElementById('toggleCameraButton');
            const toggleFlashButton = document.getElementById('toggleFlashButton');
            const submitManualBarcode = document.getElementById('submitManualBarcode');
            const manualBarcodeInput = document.getElementById('manualBarcodeInput');
            const barcodeUnsupportedMessage = document.getElementById('barcodeUnsupportedMessage');
            const barcodeScannerContainer = document.getElementById('barcodeScannerContainer');
            const barcodeStatus = document.getElementById('barcodeStatus');
            const barcodeButton = document.getElementById('barcodeButton');
            
            // Ov캩콏en칤 dostupnosti API pro skenov치n칤
            const isBarcodeDetectorAvailable = () => {
                return 'BarcodeDetector' in window;
            };
            
            const isCameraAvailable = () => {
                return navigator.mediaDevices && navigator.mediaDevices.getUserMedia;
            };
            
            // Nastaven칤 zpr치vy o podpo콏e
            if (!isBarcodeDetectorAvailable() || !isCameraAvailable()) {
                barcodeUnsupportedMessage.style.display = 'block';
                barcodeScannerContainer.style.display = 'none';
                toggleCameraButton.style.display = 'none';
                toggleFlashButton.style.display = 'none';
            } else {
                barcodeUnsupportedMessage.style.display = 'none';
                barcodeScannerContainer.style.display = 'block';
                toggleCameraButton.style.display = 'inline-block';
                toggleFlashButton.style.display = 'inline-block';
                
                // Inicializace BarcodeDetector API
                try {
                    barcodeDetector = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'code_128', 'code_39'] });
                } catch (e) {
                    console.error('BarcodeDetector initialization failed:', e);
                    barcodeStatus.textContent = 'Skenov치n칤 nen칤 podporov치no v tomto prohl칤쬰캜i';
                    barcodeStatus.className = 'barcode-status error';
                }
            }
            
            // Otev콏en칤 mod치ln칤ho okna
            barcodeButton.addEventListener('click', () => {
                barcodeModal.style.display = 'flex';
                barcodeStatus.textContent = 'P콏ipravuji skener...';
                barcodeStatus.className = 'barcode-status info';
                
                if (isBarcodeDetectorAvailable() && isCameraAvailable()) {
                    startCamera();
                }
            });
            
            // Zav콏en칤 mod치ln칤ho okna
            closeBarcodeModal.addEventListener('click', closeBarcodeScanner);
            
            // P콏epnut칤 kamery
            toggleCameraButton.addEventListener('click', toggleCamera);
            
            // Odesl치n칤 ru캜n캩 zadan칠ho k칩du
            submitManualBarcode.addEventListener('click', () => {
                const barcode = manualBarcodeInput.value.trim();
                if (barcode) {
                    handleBarcodeDetected(barcode);
                } else {
                    barcodeStatus.textContent = 'Pros칤m, zadejte 캜치rov칳 k칩d';
                    barcodeStatus.className = 'barcode-status error';
                }
            });
            
            // Odesl치n칤 p콏i stisku Enter
            manualBarcodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitManualBarcode.click();
                }
            });
        }
        
        // Spu코t캩n칤 kamery
        async function startCamera() {
            const barcodeVideo = document.getElementById('barcodeVideo');
            const barcodeStatus = document.getElementById('barcodeStatus');
            
            // Zastav칤me existuj칤c칤 stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            const constraints = {
                video: {
                    facingMode: facingMode,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            // Pokud m치me ulo쬰n칠 deviceId, pou쬴jeme ho
            if (currentDeviceId) {
                constraints.video.deviceId = { exact: currentDeviceId };
            }
            
            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                barcodeVideo.srcObject = stream;
                
                // Ulo쮂셠e deviceId pro p콏칤코t캩
                const videoTrack = stream.getVideoTracks()[0];
                if (videoTrack) {
                    currentDeviceId = videoTrack.getSettings().deviceId;
                }
                
                // 캛ek치me na na캜ten칤 videa
                barcodeVideo.onloadedmetadata = () => {
                    barcodeVideo.play();
                    barcodeStatus.textContent = 'Nami콏te na 캜치rov칳 k칩d';
                    barcodeStatus.className = 'barcode-status info';
                    startBarcodeScanning();
                };
            } catch (error) {
                console.error('Chyba p콏i p콏칤stupu ke kame콏e:', error);
                barcodeStatus.textContent = 'Chyba: ' + error.message;
                barcodeStatus.className = 'barcode-status error';
            }
        }
        
        // Spu코t캩n칤 skenov치n칤 캜치rov칳ch k칩d콢
        function startBarcodeScanning() {
            const barcodeVideo = document.getElementById('barcodeVideo');
            const barcodeStatus = document.getElementById('barcodeStatus');
            
            // Zastav칤me existuj칤c칤 interval
            if (scanInterval) {
                clearInterval(scanInterval);
            }
            
            barcodeScannerActive = true;
            
            // Nastav칤me interval pro kontrolu 캜치rov칳ch k칩d콢
            scanInterval = setInterval(async () => {
                if (barcodeVideo.readyState === barcodeVideo.HAVE_ENOUGH_DATA && barcodeScannerActive) {
                    try {
                        const barcodes = await barcodeDetector.detect(barcodeVideo);
                        
                        if (barcodes.length > 0) {
                            const barcode = barcodes[0].rawValue;
                            handleBarcodeDetected(barcode);
                        }
                    } catch (error) {
                        console.error('Chyba p콏i detekci 캜치rov칠ho k칩du:', error);
                    }
                }
            }, 500); // Kontrolujeme ka쬯칳ch 500ms
        }
        
        // Zpracov치n칤 nalezen칠ho 캜치rov칠ho k칩du
        function handleBarcodeDetected(barcode) {
            const barcodeStatus = document.getElementById('barcodeStatus');
            
            console.log('Nalezen 캜치rov칳 k칩d:', barcode);
            
            // Vizu치ln칤 feedback
            barcodeStatus.textContent = `Nalezen k칩d: ${barcode}`;
            barcodeStatus.className = 'barcode-status success';
            
            // Zastav칤me skenov치n칤
            barcodeScannerActive = false;
            clearInterval(scanInterval);
            
            // Po kr치tk칠 prodlev캩 zav콏eme skener a vyhled치me
            setTimeout(() => {
                closeBarcodeScanner();
                searchByBarcode(barcode);
            }, 1000);
        }
        
        // P콏epnut칤 kamery (p콏edn칤/zadn칤)
        async function toggleCamera() {
            const barcodeStatus = document.getElementById('barcodeStatus');
            
            facingMode = facingMode === 'environment' ? 'user' : 'environment';
            barcodeStatus.textContent = 'P콏ep칤n치m kameru...';
            barcodeStatus.className = 'barcode-status info';
            
            try {
                await startCamera();
            } catch (error) {
                console.error('Chyba p콏i p콏ep칤n치n칤 kamery:', error);
                barcodeStatus.textContent = 'Chyba: ' + error.message;
                barcodeStatus.className = 'barcode-status error';
            }
        }
        
        // Vyhled치n칤 podle 캜치rov칠ho k칩du
        function searchByBarcode(barcode) {
            // Nastav칤me hodnotu do vyhled치vac칤ho pole
            document.getElementById('query').value = barcode;
            
            // Spust칤me vyhled치v치n칤
            const searchForm = document.getElementById('searchForm');
            if (searchForm) {
                const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                searchForm.dispatchEvent(submitEvent);
            }
        }
        
        // Zav콏en칤 skeneru 캜치rov칳ch k칩d콢
        function closeBarcodeScanner() {
            // Zastav칤me skenov치n칤
            barcodeScannerActive = false;
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            
            // Zastav칤me stream videa
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // Zastav칤me video
            const barcodeVideo = document.getElementById('barcodeVideo');
            if (barcodeVideo) {
                barcodeVideo.srcObject = null;
            }
            
            // Skryjeme mod치ln칤 okno
            const barcodeModal = document.getElementById('barcodeModal');
            if (barcodeModal) {
                barcodeModal.style.display = 'none';
            }
            
            // Vy캜ist칤me status
            const barcodeStatus = document.getElementById('barcodeStatus');
            if (barcodeStatus) {
                barcodeStatus.textContent = '';
                barcodeStatus.className = 'barcode-status';
            }
            
            // Vy캜ist칤me ru캜n칤 vstup
            const manualBarcodeInput = document.getElementById('manualBarcodeInput');
            if (manualBarcodeInput) {
                manualBarcodeInput.value = '';
            }
        }
        
        // Inicializace aplikace
        initializeFirebase();
        
        // Zbytek va코eho k칩du...
    </script>
</body>
</html>